## 谈谈 mysql 的几种 log

最近在看极客时间的 Mysql 的专栏, 弥补了不少之前对Mysql的空白知识, 其中关于log这方面的空白更多，写一篇文章总结下。

mysql 的最基本的 log 是 binlog 即二进制 log ,binlog 不分引擎,以二进制的结构存储了所有操作(这里的所有操作不包括在断电时候保留的日志), binlog 可以保证在配合数据库备份的前提下,根据备份和binlog可以恢复到某一个时间点的数据库状态，但如果使用的是 myisam 无法保证断电瞬间的数据，原因很简单:因为很可能断电发生在写binlog 的时刻，当时的写操作很有可能没有写入到 binlog 文件夹。断电恢复之后，无法恢复这部分的数据，如果数据库并发量低还好，并发量高的情况下，损失的这部分数据不可忽视，且可能为公司带来极大损失。

为了解决 myisam 的各种问题, innodb 引擎出现了，不仅为数据库带来了 btree 索引和事务，也带来了断电恢复的能力，简单的来说 innodb 通过二阶段提交的方式，来解决断电数据丢失的问题: innodb 新增加了redolog和undolog 前者就是断电恢复能力的来源:每当更新数据库的时候，innodb 会先尝试从内存读取数据，如果内存内没有对应 的库表内容，则会从磁盘读取，读取加载到内存后，会生更新数据，并且生成对应的 redolog  此时的redolog 处于prepare状态，如果此时断电，redolog不会flush到binlog，数据也不会落盘到数据库,如果此时binlog写入到了磁盘，redolog会变更为 commit 状态，数据落盘到数据库，提交完成，如果在commit时期断电，在恢复的时候mysql会检查commit的数据是否落盘，如果没有落盘，则会补提交。

值得一提的是，redolog的写入方式类似于队列写入，有一个环形结构，redolog的文件大小限定，每当redolog写到上限，便会擦除一部分redolog 以保证redolog的持续写入。